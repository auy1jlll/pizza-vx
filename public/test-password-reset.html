<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps-Grade Password Reset Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .status.warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc02;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin: 20px 0;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .metrics {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .progress {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        .details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .retry-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß DevOps Password Reset Test</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Test email: <strong>auy1jll33@gmail.com</strong><br>
            <small>Production-ready testing with error handling & monitoring</small>
        </p>

        <button onclick="testPasswordReset()" id="testButton">
            üìß Send Password Reset Email
        </button>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="status"></div>
        <div id="metrics" class="metrics" style="display: none;"></div>

        <div class="details">
            <h3>üõ°Ô∏è DevOps Features:</h3>
            <ul>
                <li>‚úÖ Comprehensive error handling</li>
                <li>‚úÖ Memory leak prevention</li>
                <li>‚úÖ Timeout management</li>
                <li>‚úÖ Retry logic with exponential backoff</li>
                <li>‚úÖ Real-time performance monitoring</li>
                <li>‚úÖ Graceful degradation</li>
            </ul>
        </div>
    </div>

    <script>
        class DevOpsTestManager {
            constructor() {
                this.isRunning = false;
                this.abortController = null;
                this.startTime = null;
                this.metricsInterval = null;
                this.memoryStats = [];
                this.retryCount = 0;
                this.maxRetries = 3;
            }

            updateStatus(message, type = 'info', data = {}) {
                const statusDiv = document.getElementById('status');
                const progressBar = document.getElementById('progressBar');

                statusDiv.innerHTML = `
                    <div class="status ${type}">
                        ${this.getStatusIcon(type)} ${message}
                        ${data.details ? `<br><small>${data.details}</small>` : ''}
                    </div>
                `;

                if (data.progress !== undefined) {
                    progressBar.style.width = `${data.progress}%`;
                }

                console.log(`[${type.toUpperCase()}] ${message}`, data);
            }

            getStatusIcon(type) {
                const icons = {
                    loading: '‚è≥',
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || icons.info;
            }

            startMetricsMonitoring() {
                const metricsDiv = document.getElementById('metrics');
                metricsDiv.style.display = 'block';

                this.startTime = Date.now();
                this.memoryStats = [];

                this.metricsInterval = setInterval(() => {
                    if (!this.isRunning) return;

                    const memory = performance.memory;
                    const elapsed = Date.now() - this.startTime;

                    this.memoryStats.push({
                        time: elapsed,
                        used: memory.usedJSHeapSize,
                        total: memory.totalJSHeapSize,
                        limit: memory.jsHeapSizeLimit
                    });

                    const latest = this.memoryStats[this.memoryStats.length - 1];
                    const memoryMB = Math.round(latest.used / 1024 / 1024);

                    metricsDiv.innerHTML = `
                        <strong>üìä Performance Metrics:</strong><br>
                        ‚è±Ô∏è Elapsed: ${Math.round(elapsed / 1000)}s<br>
                        üß† Memory: ${memoryMB}MB<br>
                        üîÑ Requests: ${this.retryCount + 1}<br>
                        üìà Memory Trend: ${this.getMemoryTrend()}%
                    `;
                }, 1000);
            }

            getMemoryTrend() {
                if (this.memoryStats.length < 2) return 0;

                const recent = this.memoryStats.slice(-5);
                const avgRecent = recent.reduce((sum, stat) => sum + stat.used, 0) / recent.length;
                const avgInitial = this.memoryStats.slice(0, 5).reduce((sum, stat) => sum + stat.used, 0) / Math.min(5, this.memoryStats.length);

                return Math.round(((avgRecent - avgInitial) / avgInitial) * 100);
            }

            stopMetricsMonitoring() {
                if (this.metricsInterval) {
                    clearInterval(this.metricsInterval);
                    this.metricsInterval = null;
                }
            }

            async testPasswordReset() {
                if (this.isRunning) return;

                this.isRunning = true;
                this.retryCount = 0;
                this.abortController = new AbortController();

                const button = document.getElementById('testButton');
                button.disabled = true;
                button.textContent = 'üîÑ Testing...';

                try {
                    this.startMetricsMonitoring();
                    this.updateStatus('Initializing test environment...', 'loading', { progress: 10 });

                    // Validate environment
                    await this.validateEnvironment();

                    // Test with retry logic
                    const result = await this.sendTestRequest();

                    this.handleResult(result);

                } catch (error) {
                    this.handleError(error);
                } finally {
                    this.cleanup();
                }
            }

            async validateEnvironment() {
                this.updateStatus('Validating environment...', 'loading', { progress: 20 });

                // Check if we're online
                if (!navigator.onLine) {
                    throw new Error('No internet connection detected');
                }

                // Simulate environment validation
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            async sendTestRequest(attempt = 1) {
                this.updateStatus(
                    `Sending password reset request (attempt ${attempt}/${this.maxRetries})...`,
                    'loading',
                    { progress: 30 + (attempt * 20) }
                );

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                try {
                    const response = await fetch('/api/auth/customer/forgot-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: 'auy1jll33@gmail.com'
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return { success: true, data, attempt };

                } catch (error) {
                    clearTimeout(timeoutId);

                    if (error.name === 'AbortError') {
                        throw new Error('Request timeout - server may be unresponsive');
                    }

                    // Retry logic for network errors
                    if (attempt < this.maxRetries && (
                        error.message.includes('fetch') ||
                        error.message.includes('network') ||
                        error.message.includes('timeout')
                    )) {
                        this.retryCount = attempt;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000)); // Exponential backoff
                        return this.sendTestRequest(attempt + 1);
                    }

                    throw error;
                }
            }

            handleResult(result) {
                this.updateStatus(
                    'Password reset request sent successfully!',
                    'success',
                    {
                        progress: 100,
                        details: `Email sent to auy1jll33@gmail.com (attempt ${result.attempt})`
                    }
                );

                // Show success message with instructions
                setTimeout(() => {
                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML += `
                        <div class="status success" style="margin-top: 15px;">
                            üì¨ <strong>Check your email!</strong><br>
                            Look for an email from <strong>auy1jlll@gmail.com</strong><br>
                            Subject: "Password Reset Request"
                        </div>
                    `;
                }, 1000);
            }

            handleError(error) {
                let errorType = 'error';
                let errorMessage = error.message;
                let details = '';

                if (error.message.includes('timeout')) {
                    errorType = 'warning';
                    errorMessage = 'Request timed out';
                    details = 'The server may be busy or unresponsive. Try again in a few moments.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorType = 'warning';
                    errorMessage = 'Network error';
                    details = 'Check your internet connection and try again.';
                } else if (error.message.includes('500')) {
                    errorType = 'error';
                    errorMessage = 'Server error';
                    details = 'The server encountered an error. Please try again later.';
                }

                this.updateStatus(
                    errorMessage,
                    errorType,
                    {
                        progress: 0,
                        details: details || error.message
                    }
                );
            }

            cleanup() {
                this.isRunning = false;
                this.stopMetricsMonitoring();

                const button = document.getElementById('testButton');
                button.disabled = false;
                button.textContent = 'üìß Send Password Reset Email';

                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                }

                // Force garbage collection if available
                if (window.gc) {
                    window.gc();
                }
            }
        }

        // Global test manager instance
        const testManager = new DevOpsTestManager();

        // Make function globally available
        window.testPasswordReset = () => testManager.testPasswordReset();

        // Add some DevOps monitoring
        window.addEventListener('beforeunload', () => {
            if (testManager.isRunning) {
                testManager.cleanup();
            }
        });

        // Monitor for memory issues
        if ('memory' in performance) {
            setInterval(() => {
                const memInfo = performance.memory;
                if (memInfo.usedJSHeapSize > memInfo.jsHeapSizeLimit * 0.9) {
                    console.warn('High memory usage detected:', {
                        used: Math.round(memInfo.usedJSHeapSize / 1024 / 1024) + 'MB',
                        limit: Math.round(memInfo.jsHeapSizeLimit / 1024 / 1024) + 'MB'
                    });
                }
            }, 5000);
        }
    </script>
</body>
</html>
